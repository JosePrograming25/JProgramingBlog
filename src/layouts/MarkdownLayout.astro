---
import Layout from "./Layout.astro";
import ImageZoom from "../components/ImageZoom.astro";

const { frontmatter } = Astro.props;
---

<Layout title={frontmatter.title}>
  <article class="max-w-3xl mx-auto px-6 py-10" data-pagefind-body>
    {/* Header del Post */}
    <header class="mb-10 text-center">
      {
        frontmatter.image && (
          <img
            src={frontmatter.image}
            alt={frontmatter.title}
            class="w-full h-[300px] md:h-[400px] object-cover rounded-2xl shadow-lg mb-8"
            transition:name={`image-${frontmatter.title}`}
          />
        )
      }
      <div
        class="flex items-center justify-center gap-4 text-sm text-muted-foreground mb-4"
      >
        {
          frontmatter.date && (
            <time datetime={frontmatter.date}>
              {new Date(frontmatter.date).toLocaleDateString("es-ES", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })}
            </time>
          )
        }
        {
          frontmatter.type && (
            <span class="px-3 py-1 bg-secondary text-secondary-foreground rounded-full text-xs font-medium uppercase tracking-wider">
              {frontmatter.type}
            </span>
          )
        }
      </div>
      <h1
        class="text-3xl md:text-5xl font-extrabold tracking-tight text-foreground mb-4 leading-tight"
      >
        {frontmatter.title}
      </h1>
      {
        frontmatter.description && (
          <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
            {frontmatter.description}
          </p>
        )
      }
    </header>

    {/* Contenido del Post */}
    <div
      class="prose prose-lg dark:prose-invert prose-slate mx-auto
      prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-foreground
      prose-a:text-primary prose-a:no-underline hover:prose-a:underline
      prose-strong:text-foreground
      prose-code:text-primary prose-code:bg-secondary/50 prose-code:px-1 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
      prose-pre:bg-slate-900 prose-pre:border prose-pre:border-slate-800
      prose-img:rounded-xl prose-img:shadow-md
      [&_pre_code]:bg-transparent [&_pre_code]:text-inherit [&_pre_code]:p-0"
    >
      <slot />
    </div>
  </article>
  <ImageZoom />
</Layout>

<script>
  // Copy Code Button Logic
  const codeBlocks = document.querySelectorAll("pre");

  codeBlocks.forEach((pre) => {
    // Create container for relative positioning if not already
    const wrapper = document.createElement("div");
    wrapper.className = "relative group";

    // Insert wrapper before pre
    pre.parentNode?.insertBefore(wrapper, pre);
    // Move pre into wrapper
    wrapper.appendChild(pre);

    // Create copy button
    const button = document.createElement("button");
    button.className =
      "absolute top-3 right-3 p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition-all duration-200 opacity-0 group-hover:opacity-100 focus:opacity-100";
    button.setAttribute("aria-label", "Copiar c√≥digo");
    button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
    `;

    // Add click event
    button.addEventListener("click", async () => {
      const code = pre.querySelector("code")?.innerText || "";

      try {
        await navigator.clipboard.writeText(code);

        // Change icon to check
        button.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-green-400"><path d="M20 6 9 17l-5-5"/></svg>
        `;

        setTimeout(() => {
          // Revert icon
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          `;
        }, 2000);
      } catch (err) {
        console.error("Failed to copy:", err);
      }
    });

    wrapper.appendChild(button);
  });
</script>
